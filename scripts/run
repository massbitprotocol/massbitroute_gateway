#!/bin/bash
SITE_ROOT=$(realpath $(dirname $(realpath $0))/..)
export HOME=/tmp
cd $SITE_ROOT
source $SITE_ROOT/.env
git="git -C $SITE_ROOT"
type="gateway"
mbr="/massbit/massbitroute/app/src/sites/services/$type/mbr"
script_run="/massbit/massbitroute/app/src/sites/services/$type/scripts/run"
cmd="/massbit/massbitroute/app/src/sites/services/$type/cmd_server"
nginx="$cmd nginx"
_git_config() {
	$git config --global user.name "Vu Tran"
	$git config --global user.email "baysao@gmail.com"
}
_reload() {
	$cmd _update
	# $mbr $type register
	# $nginx -s reload
}

loop() {
	while true; do
		$0 $@
		sleep 10
	done
}
_deprecate() {
	n=$(ls http.d/*.conf | wc -l)
	if [ $n -ne 2 ]; then
		rm -rf http.d/*
	fi
}
_update_src() {
	cd gbc
	git pull origin master
	cd $SITE_ROOT
}
_monitor() {
	$0 _deprecate
	$0 _update_src
	is_reload=0
	id=$(cat $SITE_ROOT/vars/ID)
	blockchain=$(cat $SITE_ROOT/vars/BLOCKCHAIN)
	network=$(cat $SITE_ROOT/vars/NETWORK)
	blnet=${blockchain}-${network}
	curl -sSfL $MBR_API/deploy/${type}conf/${blnet}.conf -o http.d/${type}.conf.new
	diff http.d/${type}.conf http.d/${type}.conf.new
	if [ $? -ne 0 ]; then
		mv http.d/${type}.conf.new http.d/${type}.conf
		is_reload=1
	fi

	conf=http.d/${blnet}.conf
	curl -sSfL $MBR_API/deploy/dapiconf/${blnet}.conf -o ${conf}.new
	if [ ! -f ${conf}.orig ]; then touch ${conf}.orig; fi
	diff ${conf}.orig ${conf}.new
	if [ $? -ne 0 ]; then
		mv ${conf}.new ${conf}.orig
		is_reload=1
	fi

	sed "s/__GATEWAY_ID__/$id/g" ${conf}.orig >$conf

	$git pull | grep -i "updating"
	if [ $? -eq 0 ]; then
		is_reload=1
	fi
	if [ $is_reload -ne 0 ]; then
		$0 _reload
	fi
	$mbr $type ping
}

_run() {
	$SITE_ROOT/start_server
}

$@
