#!/bin/bash
SITE_ROOT=$(realpath $(dirname $(realpath $0))/..)
export HOME=/tmp
cd $SITE_ROOT
source $SITE_ROOT/.env
git="git -C $SITE_ROOT"
type="gateway"
mbr_cli="/massbit/massbitroute/app/src/sites/services/$type/mbr"
script_run="/massbit/massbitroute/app/src/sites/services/$type/scripts/run"
cmd="/massbit/massbitroute/app/src/sites/services/$type/cmd_server"
nginx="$cmd nginx"
_git_config() {
	$git config --global user.name "Vu Tran"
	$git config --global user.email "baysao@gmail.com"
}
_reload() {
	$nginx -s reload
}

loop() {
	while true; do
		$0 $@
		sleep 10
	done
}
_deprecate() {
	n=$(ls http.d | wc -l)
	if [ \( $n -ne 4 \) -a \( $n -ne 2 \) ]; then
		rm -rf http.d/*
	fi
}
_monitor() {
	_deprecate
	is_reload=0
	id=$(cat $SITE_ROOT/vars/ID)
	blockchain=$(cat $SITE_ROOT/vars/BLOCKCHAIN)
	network=$(cat $SITE_ROOT/vars/NETWORK)
	curl -sSfL $MBR_API/deploy/${type}conf/${blockchain}-${network}.conf -o http.d/${type}.conf.new
	diff http.d/${type}.conf http.d/${type}.conf.new
	if [ $? -ne 0 ]; then
		mv http.d/${type}.conf.new http.d/${type}.conf
		is_reload=1
	fi

	curl -sSfL $MBR_API/deploy/dapiconf/${blockchain}-${network}.conf -o http.d/${blockchain}-${network}.conf.new
	diff http.d/${blockchain}-${network}.conf http.d/${blockchain}-${network}.conf.new
	if [ $? -ne 0 ]; then
		mv http.d/${blockchain}-${network}.conf.new http.d/${blockchain}-${network}.conf
		is_reload=1
	fi

	$git pull | grep -i "updating"
	if [ $? -eq 0 ]; then
		is_reload=1
	fi
	if [ $is_reload -ne 0 ]; then
		$0 _reload
	fi
	$mbr_cli $type ping
}

_run() {
	$SITE_ROOT/start_server
}

$@
